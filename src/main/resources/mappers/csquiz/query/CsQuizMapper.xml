<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.freepath.devpath.csquiz.query.mapper.CsQuizQueryMapper">

    <resultMap id="QuizWithOptionsMap" type="com.freepath.devpath.csquiz.query.dto.response.CsQuizPreviewDTO">
        <id property="csquizId" column="csquiz_id"/>
        <result property="csquizContents" column="csquiz_contents"/>
        <collection property="options" ofType="com.freepath.devpath.csquiz.query.dto.response.CsQuizOptionDTO">
            <result property="optionNo" column="option_no"/>
            <result property="optionContents" column="option_contents"/>
        </collection>
    </resultMap>

    <select id="findWeeklyQuiz" resultMap="QuizWithOptionsMap">
        SELECT
        q.csquiz_id,
        q.csquiz_contents,
        o.option_no,
        o.option_contents
        FROM csquiz q
        LEFT JOIN csquiz_option o ON q.csquiz_id = o.csquiz_id
        WHERE q.is_csquiz_submitted = 'Y'
        ORDER BY q.csquiz_id DESC
        LIMIT 40
    </select>

    <select id="findQuizById" resultMap="QuizWithOptionsMap" parameterType="long">
        SELECT
        q.csquiz_id,
        q.csquiz_contents,
        q.csquiz_answer,
        q.csquiz_explanation,
        o.option_no,
        o.option_contents
        FROM csquiz q
        LEFT JOIN csquiz_option o ON q.csquiz_id = o.csquiz_id
        WHERE q.csquiz_id = #{csquizId}
    </select>

    <select id="findAllQuizzes" resultMap="QuizWithOptionsMap">
        SELECT
        q.csquiz_id,
        q.csquiz_contents,
        q.csquiz_answer,
        q.csquiz_explanation,
        o.option_no,
        o.option_contents
        FROM csquiz q
        LEFT JOIN csquiz_option o ON q.csquiz_id = o.csquiz_id
        ORDER BY q.csquiz_id
    </select>

    <select id="countCorrectAnswersByUserId" resultType="int">
        SELECT COUNT(*)
        FROM csquiz_result
        WHERE user_id = #{userId}
        AND is_csquiz_correct = 'Y'
    </select>

</mapper>